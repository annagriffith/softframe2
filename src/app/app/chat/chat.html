<!--
This file is the chat page template for the Frametry6 app.
It displays messages for the selected channel, lets users send new messages, and shows the chat UI.
Use this to answer questions about how chat works in the project.
-->
<h1>Chat</h1>
<div *ngIf="channelId; else noChannel">
	<div class="mb-3">
		<h4>Channel: {{ channelId }}</h4>
		<!-- Incoming call toast (auto-join is still enabled) -->
		<div *ngIf="showCallToast" class="call-toast">
			<span>Incoming call<span *ngIf="callFrom"> from {{ callFrom }}</span>â€¦</span>
			<button type="button" class="btn btn-sm" (click)="acceptCall()">Join</button>
			<button type="button" class="btn btn-sm btn-outline" (click)="declineCall()">Dismiss</button>
		</div>

		<ul class="list-group mb-3">
			<li *ngFor="let msg of messages; trackBy: trackByIndex" class="list-group-item d-flex align-items-start">
				<img *ngIf="msg.imagePath && msg.type==='image'" [src]="msg.imagePath" class="msg-image" alt="image message" />
				<div>
					<div class="d-flex align-items-center">
						<img *ngIf="msg.avatar" [src]="msg.avatar" alt="avatar" class="msg-avatar" />
						<strong>{{ msg.sender }}</strong>
						<span class="text-muted chat-time">{{ msg.timestamp | date:'short' }}</span>
					</div>
					<div class="mt-1" *ngIf="msg.type !== 'callInvite'">{{ msg.text }}</div>
				</div>
			</li>
		</ul>

		<form (ngSubmit)="sendMessage(); $event.preventDefault()" class="input-group" autocomplete="off">
			<input type="text" [(ngModel)]="newMessage" name="message" class="form-control" placeholder="Type a message..." (keydown.enter)="sendMessage(); $event.preventDefault()">
			<button type="submit" class="btn btn-primary" [disabled]="!newMessage.trim()">Send</button>
		</form>
		<div class="mt-2">
			<button *ngIf="channelId" (click)="startCall()" class="btn btn-outline-secondary btn-sm mt-2">Start/Join Call for this Channel</button>
		</div>
		<div class="mt-2">
			<div *ngIf="imagePreviewUrl" class="mb-2">
				<p class="mb-1">Preview:</p>
				<img [src]="imagePreviewUrl" class="msg-image" alt="preview" />
			</div>
			<label class="file-input-label">Upload image
				<input type="file" (change)="onImageSelected($event)" accept="image/*" />
			</label>
		</div>
	</div>
</div>
<ng-template #noChannel>
	<p>Select a channel from your groups to start chatting.</p>
</ng-template>
